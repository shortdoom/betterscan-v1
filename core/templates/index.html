<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link rel="stylesheet" href="/static/default.min.css" />
    <script src="/static/js/highlight.min.js"></script>
    <script
      type="text/javascript"
      src="/static/js/editor/ace.js"
      charset="utf-8"
    ></script>
    <script type="text/javascript" src="/static/js/solidity.min.js"></script>
    <script type="text/javascript" src="/static/js/yul.min.js"></script>
    <script type="text/javascript">
      hljs.highlightAll();
    </script>
    <script type="module" src="/static/js/components/contract_page.js"></script>
  </head>
  <body>
    <div class="header" onclick="window.location.href='/'">
      <h1>┗┫⦀⦙ｂｅｔｔｅｒｓｃａｎ⦙⦀┣┛</h1>
    </div>
    <div id="dashboard">
      <div id="inputDropdownFlex">
        <div id="inputGroup">
          <input
            type="text"
            id="pathInput"
            placeholder="<network>:<address> or explorer url"
            style="width: 450px"
          />
          <input
            type="text"
            id="paramInput"
            placeholder="optional: api/contract_name"
            style="color: #fff"
          />
          <button id="loadDataButton">Load</button>
        </div>
        <div id="dropdownContainer"></div>
      </div>

      <div id="menuGroup">
        <button id="openTargetsButton">Targets</button>
        <button id="reportButton">Report</button>
        <button id="clearDataButton">Clean Storage</button>
        <button id="protocolViewButton">ProtocolView</button>
      </div>

      <div id="homepage">
        <h2 id="homepage-headers">█ Betterscan v0.1 █</h2>
        <p>
          Betterscan is a security tool designed to parse, analyze, and display
          data of any EVM-based smart contracts. It provides a visual
          representation of the contract's source code and its dependencies,
          along with additional data. The tool allows you to search for specific
          functions, variables, and contracts while also finding intersections
          within all data. You can run automatic detectors on the target
          contract and filter the results based on impact and check type.
          Betterscan uses localStorage for session storage, enabling you to save
          and load multiple contract data in the same browser.
        </p>
        <h3 id="homepage-headers">~Features~</h3>
        <ul>
          <li>Out-of-the-box compilation of etherscan verified source code</li>
          <li>
            Inspect details of contracts, functions, variables, internal and
            external calls, modifiers, expressions, low-level calls, inline
            assembly, and more
          </li>
          <li>
            Advanced search in source code and other data using multiple
            pre-defined filters
          </li>
          <li>Makes solc compilation artifacts human readable</li>
          <li>Quick-navigate to the most relevant data</li>
          <li>
            Automatic Slither, slitherin and semgrep detectors run on the target
            contract
          </li>
          <li>Fast prompt generation for specific function flows</li>
          <li>Keep multiple workspaces open in browser with Localstorage</li>
        </ul>
        <h3 id="homepage-headers">~Usage~</h3>
        <p>
          In the input field next to the "Load" button, enter: network:0x...,
          where the network can be mainnet, ropsten, kovan, rinkeby, goerli,
          tobalaba, arbi, testnet.arbi, poly, avax, testnet.avax, ftm, bsc, or
          testnet.bsc.
        </p>

        <p>
          Etherscan API key is optional. If left empty, global rate limits are
          applied. If set, each etherscan platform has it's own unique key that
          needs to match with target network.
        </p>

        <p>
          Currently, only contracts with a verified source code on any (mainet,
          arbi, opti etc.) of the Etherscan platforms are allowed as targets of
          Betterscan.
        </p>

        <p>
          Github integration and local directories integration is considered
          experimental, works 50% of the time. If you are intending to download
          and compile github repository, you'll need to specify the name of the
          target contract in additional input box.
        </p>

        <p>
          Once the target contract is loaded, a dashboard will appear. The
          dashboard is divided into sections like network information, contract
          data, state variables, detector results, search form, function data,
          and source code data. Most of these sections allow for
          cross-navigation and cross-searching (i.e., function data can be
          filtered by detector results).
        </p>

        <p>
          Betterscan uses localStorage for persistent session storage. You can
          clear the session data by selecting the session from the dropdown and
          setting the action to "Clear Data". You can also re-load a session by
          entering the same network:address target. Or, you can jump to a
          session by selecting it from the dropdown and setting the action to
          "Jump To Session".
        </p>
        <h3 id="homepage-headers">~Coming Soon~</h3>
        <p>
          If you are interested in further development of Betterscan, contact me
          on Twitter. There're a lot more potential features to add and focus of
          this project is to stay open source. The UI is very hacky and needs a
          lot of work. The code is also not very clean and needs refactoring. If
          you are interested in adjusting this for your company requirements -
          ping me (see the footnote)!
        </p>
        <p style="text-align: right">
          <a
            href="https://github.com/shortdoom"
            style="color: black; font-size: small"
            >by blackbigswan</a
          >
        </p>
      </div>

      <div id="contractDisplay"></div>

      <div id="searchDisplay" style="display: none">
        <h3>Search functions</h3>
        <form id="searchForm">
          <!-- Group 1: Filters (Left Side) -->
          <div id="filterGroup" class="form-section">
            <div class="select-group">
              <label for="visibility">Visibility</label>
              <select name="visibility" id="visibility">
                <option value="">Any</option>
                <option value="public">Public</option>
                <option value="external">External</option>
                <option value="internal">Internal</option>
                <option value="private">Private</option>
              </select>
            </div>

            <div class="select-group">
              <label for="priority">Mutability</label>
              <select name="priority" id="priority">
                <option value="">Any</option>
                <option value="1">Write (public/external)</option>
                <option value="2">Write (internal/private)</option>
                <option value="3">Read (view/pure)</option>
              </select>
            </div>

            <div class="select-group">
              <label for="scanResult">Slither Results</label>
              <select name="impact">
                <option value="">All</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
                <option value="Informational">Informational</option>
              </select>
            </div>

            <div class="select-group">
              <label for="functionName">Function Name</label>
              <input
                type="text"
                name="functionName"
                id="functionName"
                placeholder="Type function name or it's part"
              />
            </div>

            <div class="checkbox-group">
              <label>Modifiers</label>
              <input type="checkbox" name="hasModifiers" value="true" />

              <label>Internal Calls</label>
              <input type="checkbox" name="hasInternalCalls" value="true" />

              <label>External Calls</label>
              <input type="checkbox" name="hasExternalCalls" value="true" />

              <label>Inherited</label>
              <input type="checkbox" name="isInheritedFunction" value="true" />

              <label>ASM</label>
              <input type="checkbox" name="containsAsm" value="true" />

              <label>Low-lvl-call</label>
              <input type="checkbox" name="lowLvlCall" value="true" />
            </div>
          </div>

          <div id="findGroup" class="form-section">
            <!-- Adjusted for Multiple Selections -->
            <div class="select-group">
              <label for="findAction">Select Function</label>
              <select name="findAction[]" id="findAction" multiple size="5">
                <option value="emitting">Emitting</option>
                <option value="writing_to">Writing to</option>
                <option value="reading_from">Reading from</option>
                <option value="calling_external_contract">
                  Calling external
                </option>
                <option value="find_target_reachable">Reaching target</option>
                <option value="all_reachable_from">All reachable</option>
                <option value="using_structure">Using structure</option>
                <option value="in_contract">In contract</option>
              </select>
            </div>

            <!-- Adjusted for Multiple Selections -->
            <div class="select-group">
              <label for="findTarget">Function Target</label>
              <input
                type="text"
                id="findTargetFilter"
                placeholder="Select function first. Type to search below"
              />
              <select name="findTarget[]" id="findTarget" multiple size="5">
                <!-- Options will be added based on selected actions -->
              </select>
            </div>
          </div>

          <!-- Add Reset Button inside the form, after the Search button -->
          <button type="button" onclick="resetSelections()">Reset</button>
          <button type="button" onclick="filterData()">Search</button>
        </form>
      </div>
      <div id="scanResultsSection" style="display: none">
        <h3>Search detectors</h3>
        <div class="toggleScanResults">
          <form id="scanResultFilterForm">
            <label>Impact</label>
            <select name="impact" id="impactSelect">
              <option value="">All</option>
              <option value="High">High-slither</option>
              <option value="Medium">Medium-slither</option>
              <option value="Low">Low-slither</option>
              <option value="Informational">Informational-slither</option>
              <option value="ERROR">Error-semgrep</option>
              <option value="WARNING">Warning-semgrep</option>
              <option value="INFO">Info-semgrep</option>
            </select>
            <label>Check</label>
            <select name="check_scanned" id="checkSelect">
              <option value="">All</option>
            </select>

            <label>Function</label>
            <select name="function_scanned" id="functionSelect">
              <option value="">All</option>
            </select>

            <label>Contract</label>
            <select name="contract_scanned" id="contractSelect">
              <option value="">All</option>
            </select>
            <button type="button" onclick="filterScanResults()">Show</button>
          </form>
          <button onclick="toggleScanResultsDisplay()">X</button>
        </div>
        <div id="scanResultsDisplay"></div>
      </div>

      <div id="criteriaDisplay" style="display: none"></div>

      <div id="flexContainer">
        <div id="functionDisplay"></div>
        <div id="sourceCodeDisplay"></div>
      </div>
    </div>

    <script>

      // Add event listener to the filter input for dynamic filtering
      document
        .getElementById("findTargetFilter")
        .addEventListener("input", function () {
          const filterText = this.value.toLowerCase();
          const findTargetDropdown = document.getElementById("findTarget");
          const options = findTargetDropdown.options;

          // Temporarily store options in an array to filter in JavaScript instead of live HTMLCollection
          const optionsArray = Array.from(options);

          // Hide all options initially
          optionsArray.forEach((option) => {
            option.style.display = "none";
          });

          // Filter and display matching options
          const filteredOptions = optionsArray.filter((option) =>
            option.text.toLowerCase().includes(filterText)
          );
          filteredOptions.forEach((option) => {
            option.style.display = "block";
          });

          // If filter is empty, reset to show all options
          if (!filterText) {
            optionsArray.forEach((option) => {
              option.style.display = "block";
            });
          }
        });

      document.addEventListener(
        "click",
        function (event) {
          if (event.target.matches(".collapsible")) {
            // Toggle collapsible sections
            hljs.highlightAll();
            var functionContent = event.target.nextElementSibling;
            functionContent.style.display =
              functionContent.style.display === "block" ? "none" : "block";
            event.target.classList.toggle("active");
          } else if (event.target.matches(".expandable")) {
            // Handle clicking on expandable buttons
            var contentId = event.target.getAttribute("data-content-id");
            var keyContentDiv = document.getElementById(contentId);

            // Toggle visibility and active state for key-content sections
            if (keyContentDiv.style.display !== "block") {
              keyContentDiv.style.display = "block";
              event.target.classList.add("active");
              keyContentDiv.classList.add("active");
            } else {
              keyContentDiv.style.display = "none";
              event.target.classList.remove("active");
              keyContentDiv.classList.remove("active");
            }

            // Update all other buttons' active state
            document.querySelectorAll(".expandable").forEach((btn) => {
              if (btn !== event.target && btn.classList.contains("active")) {
                let relatedContent = document.getElementById(
                  btn.getAttribute("data-content-id")
                );
                if (!relatedContent.classList.contains("active")) {
                  btn.classList.remove("active");
                }
              }
            });
          }
        },
        false
      );
    </script>
  </body>
</html>

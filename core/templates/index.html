<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link rel="stylesheet" href="/static/default.min.css" />
    <script src="/static/js/highlight.min.js"></script>
    <script
      type="text/javascript"
      src="/static/js/editor/ace.js"
      charset="utf-8"
    ></script>
    <script type="text/javascript" src="/static/js/solidity.min.js"></script>
    <script type="text/javascript" src="/static/js/yul.min.js"></script>

    <script type="text/javascript">
      hljs.highlightAll();
    </script>
  </head>
  <body>
    <div class="header" onclick="window.location.href='/'">
      <h1>┗┫⦀⦙ｂｅｔｔｅｒｓｃａｎ⦙⦀┣┛</h1>
    </div>
    <div id="dashboard">
      <div id="menuGroup">
        <button onclick="window.location.href='/'">Main</button>
        <button onclick="window.open('http://127.0.0.1:8001', '_blank')">
          Targets
        </button>
        <button onclick="window.location.href='/'">Comms</button>
        <button onclick="getActiveSession()">Report</button>
      </div>

      <div id="inputDropdownFlex">
        <div id="inputGroup">
          <input
            type="text"
            id="pathInput"
            placeholder="e.g, mainet:0xe592427a0aece92de3edee1f18e0157c05861564"
            style="width: 450px"
          />
          <input
            type="text"
            id="paramInput"
            placeholder="API key or Contract Name"
            style="background-color: #333333ad; color: #fff"
          />
          <button onclick="loadData()">Load</button>
        </div>
        <div id="dropdownContainer"></div>
      </div>

      <div id="homepage">
        <h2 id="homepage-headers">█ Betterscan v0.1 █</h2>
        <p>
          Betterscan is a security tool designed to parse, analyze, and display
          data of any EVM-based smart contracts. It provides a visual
          representation of the contract's source code and its dependencies,
          along with additional data. The tool allows you to search for specific
          functions, variables, and contracts while also finding intersections
          within all data. You can run automatic detectors on the target
          contract and filter the results based on impact and check type.
          Betterscan uses localStorage for session storage, enabling you to save
          and load multiple contract data in the same browser.
        </p>
        <h3 id="homepage-headers">~Features~</h3>
        <ul>
          <li>Out-of-the-box compilation of etherscan verified source code</li>
          <li>
            Inspect details of contracts, functions, variables, internal and
            external calls, modifiers, expressions, low-level calls, inline
            assembly, and more
          </li>
          <li>
            Advanced search in source code and other data using multiple
            pre-defined filters
          </li>
          <li>Makes solc compilation artifacts human readable</li>
          <li>Quick-navigate to the most relevant data</li>
          <li>
            Automatic Slither, slitherin and semgrep detectors run on the target
            contract
          </li>
          <li>Fast prompt generation for specific function flows</li>
          <li>Keep multiple workspaces open in browser with Localstorage</li>
        </ul>
        <h3 id="homepage-headers">~Usage~</h3>
        <p>
          In the input field next to the "Load" button, enter: network:0x...,
          where the network can be mainnet, ropsten, kovan, rinkeby, goerli,
          tobalaba, arbi, testnet.arbi, poly, avax, testnet.avax, ftm, bsc, or
          testnet.bsc.
        </p>

        <p>
          Etherscan API key is optional. If left empty, global rate limits are
          applied. If set, each etherscan platform has it's own unique key that
          needs to match with target network.
        </p>

        <p>
          Currently, only contracts with a verified source code on any (mainet,
          arbi, opti etc.) of the Etherscan platforms are allowed as targets of
          Betterscan.
        </p>

        <p>
          Github integration and local directories integration is considered
          experimental, works 50% of the time. If you are intending to download
          and compile github repository, you'll need to specify the name of the
          target contract in additional input box.
        </p>

        <p>
          Once the target contract is loaded, a dashboard will appear. The
          dashboard is divided into sections like network information, contract
          data, state variables, detector results, search form, function data,
          and source code data. Most of these sections allow for
          cross-navigation and cross-searching (i.e., function data can be
          filtered by detector results).
        </p>

        <p>
          Betterscan uses localStorage for persistent session storage. You can
          clear the session data by selecting the session from the dropdown and
          setting the action to "Clear Data". You can also re-load a session by
          entering the same network:address target. Or, you can jump to a
          session by selecting it from the dropdown and setting the action to
          "Jump To Session".
        </p>
        <h3 id="homepage-headers">~Coming Soon~</h3>
        <p>
          If you are interested in further development of Betterscan, contact me
          on Twitter. There're a lot more potential features to add and focus of
          this project is to stay open source. The UI is very hacky and needs a
          lot of work. The code is also not very clean and needs refactoring. If
          you are interested in adjusting this for your company requirements -
          ping me (see the footnote)!
        </p>
        <p style="text-align: right">
          <a
            href="https://github.com/shortdoom"
            style="color: black; font-size: small"
            >by blackbigswan</a
          >
        </p>
      </div>

      <div id="contractDisplay"></div>

      <div id="searchDisplay" style="display: none">
        <h3>Search functions</h3>
        <form id="searchForm">
          <!-- Group 1: Filters (Left Side) -->
          <div id="filterGroup" class="form-section">
            <div class="select-group">
              <label for="visibility">Visibility</label>
              <select name="visibility" id="visibility">
                <option value="">Any</option>
                <option value="public">Public</option>
                <option value="external">External</option>
                <option value="internal">Internal</option>
                <option value="private">Private</option>
              </select>
            </div>

            <div class="select-group">
              <label for="priority">Mutability</label>
              <select name="priority" id="priority">
                <option value="">Any</option>
                <option value="1">Write (public/external)</option>
                <option value="2">Write (internal/private)</option>
                <option value="3">Read (view/pure)</option>
              </select>
            </div>

            <div class="select-group">
              <label for="scanResult">Slither Results</label>
              <select name="impact">
                <option value="">All</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
                <option value="Informational">Informational</option>
              </select>
            </div>

            <div class="select-group">
              <label for="functionName">Function Name</label>
              <input
                type="text"
                name="functionName"
                id="functionName"
                placeholder="Type function name or it's part"
              />
            </div>

            <div class="checkbox-group">
              <label>Has Modifiers</label>
              <input type="checkbox" name="hasModifiers" value="true" />

              <label>Has Internal Calls</label>
              <input type="checkbox" name="hasInternalCalls" value="true" />

              <label>Has External Calls</label>
              <input type="checkbox" name="hasExternalCalls" value="true" />

              <label>Is inherited</label>
              <input type="checkbox" name="isInheritedFunction" value="true" />

              <label>Contains ASM</label>
              <input type="checkbox" name="containsAsm" value="true" />

              <label>Low-lvl call</label>
              <input type="checkbox" name="lowLvlCall" value="true" />
            </div>
          </div>

          <div id="findGroup" class="form-section">
            <!-- Adjusted for Multiple Selections -->
            <div class="select-group">
              <label for="findAction">Select Function</label>
              <select name="findAction[]" id="findAction" multiple size="5">
                <option value="emitting">Emitting</option>
                <option value="writing_to">Writing to</option>
                <option value="reading_from">Reading from</option>
                <option value="calling_external_contract">
                  Calling external
                </option>
                <option value="find_target_reachable">Reaching target</option>
                <option value="all_reachable_from">All reachable</option>
                <option value="using_structure">Using structure</option>
                <option value="in_contract">In contract</option>
              </select>
            </div>

            <!-- Adjusted for Multiple Selections -->
            <div class="select-group">
              <label for="findTarget">Function Target</label>
              <input
                type="text"
                id="findTargetFilter"
                placeholder="Select function first. Type to search below"
              />
              <select name="findTarget[]" id="findTarget" multiple size="5">
                <!-- Options will be added based on selected actions -->
              </select>
            </div>
          </div>

          <!-- Add Reset Button inside the form, after the Search button -->
          <button type="button" onclick="resetSelections()">Reset</button>
          <button type="button" onclick="filterData()">Search</button>
        </form>
      </div>
      <div id="scanResultsSection" style="display: none">
        <h3>Search detectors</h3>
        <div class="toggleScanResults">
          <form id="scanResultFilterForm">
            <label>Impact</label>
            <select name="impact" id="impactSelect">
              <option value="">All</option>
              <option value="High">High-slither</option>
              <option value="Medium">Medium-slither</option>
              <option value="Low">Low-slither</option>
              <option value="Informational">Informational-slither</option>
              <option value="ERROR">Error-semgrep</option>
              <option value="WARNING">Warning-semgrep</option>
              <option value="INFO">Info-semgrep</option>
            </select>
            <label>Check</label>
            <select name="check_scanned" id="checkSelect">
              <option value="">All</option>
            </select>

            <label>Function</label>
            <select name="function_scanned" id="functionSelect">
              <option value="">All</option>
            </select>

            <label>Contract</label>
            <select name="contract_scanned" id="contractSelect">
              <option value="">All</option>
            </select>
            <button type="button" onclick="filterScanResults()">Show</button>
          </form>
          <button onclick="toggleScanResultsDisplay()">X</button>
        </div>
        <div id="scanResultsDisplay"></div>
      </div>

      <div id="criteriaDisplay" style="display: none"></div>

      <div id="flexContainer">
        <div id="functionDisplay"></div>
        <div id="sourceCodeDisplay"></div>
      </div>
    </div>

    <script>
      var editor = null;
      var selectedActionTargets = [];

      // ############################### APP_NAVIGATION

      function getSessionData(session_path) {
        return JSON.parse(localStorage.getItem(session_path));
      }

      function fetchSessionData(sessionPath) {
        console.log("fetchSessionData -> sessionPath:", sessionPath);
        return fetch(
          `/get_session_data?path=${encodeURIComponent(sessionPath)}`
        )
          .then((response) => {
            if (!response.ok) {
              console.warn(
                `Could not fetch session data: ${response.statusText}`
              );
              return null;
            }
            return response.json();
          })
          .then((sessionData) => {
            if (sessionData) {
              localStorage.setItem(sessionPath, JSON.stringify(sessionData));
              return 200;
            } else {
              return null;
            }
          })
          .catch((error) => {
            console.error(`Error fetching session data: ${error}`);
            return null;
          });
      }

      function clearData() {
        var dropdown = document.getElementById("keysDropdown");
        var key = dropdown.value;

        if (key && key !== "Select a key to clear") {
          localStorage.removeItem(key);
          alert("Data cleared successfully. F5 to see changes.");
          poupulateSessionStorageDropdown();
        }
      }

      function jumpToSession(session_path) {
        window.history.pushState(
          session_path,
          "",
          `/?session_id=${session_path}`
        );
        initializeLoadData(session_path);
      }

      function getActiveSession() {
        let url = new URL(window.location.href);
        let sessionId = url.searchParams.get("session_id");
        window.location.href = "/report?session_id=" + sessionId;
      }

      function poupulateSessionStorageDropdown() {
        var select = document.createElement("select");
        select.id = "keysDropdown";

        var actionSelect = document.createElement("select");
        actionSelect.id = "actionSelect";
        var jumpOption = document.createElement("option");
        jumpOption.value = "jump";
        jumpOption.text = "Jump To Session";
        var clearOption = document.createElement("option");
        clearOption.value = "clear";
        clearOption.text = "Clear Data";
        actionSelect.appendChild(jumpOption);
        actionSelect.appendChild(clearOption);

        select.onchange = function () {
          var action = document.getElementById("actionSelect").value;
          if (action === "clear") {
            clearData();
          } else if (action === "jump") {
            jumpToSession(select.value);
          }
        };

        var defaultOption = document.createElement("option");
        defaultOption.text = "Select a session";
        select.appendChild(defaultOption);

        fetch("/list_sessions")
          .then((response) => {
            if (!response.ok) {
              return response.text().then((text) => {
                throw new Error(text);
              });
            }
            return response.json();
          })
          .then((directories) => {
            console.log("directories", directories);
            Object.entries(directories).forEach(([directory]) => {
              var option = document.createElement("option");
              var parts = directory.split(":");
              option.value = parts.slice(0, 2).join(":");
              option.text = directory;
              select.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Error fetching files/out directories:", error);
          });

        var container = document.getElementById("dropdownContainer");
        container.innerHTML = "";
        container.appendChild(select);
        container.appendChild(actionSelect);
      }

      function initializePageWithData() {
        const urlParams = new URLSearchParams(window.location.search);
        const sessionID = urlParams.get("session_id");

        if (sessionID) {
          const sessionData = JSON.parse(localStorage.getItem(sessionID));
          if (sessionData) {
            hljs.highlightAll();
            displayScanResultsSection(sessionData.scan_results);
            initScanDropdowns();
            document.getElementById("functionDisplay").innerHTML =
              createFunctionDataView(sessionData.functions_data);
            document.getElementById("contractDisplay").innerHTML =
              createContractDataView(
                sessionData.network_info,
                sessionData.contract_data,
                sessionData.variables_data
              );
            document.getElementById("searchDisplay").style.display = "block";
            document.getElementById("criteriaDisplay").style.display = "block";
            createSourceCodeView(sessionData.source_code);
            document.getElementById("homepage").style.display = "none";
          } else {
            console.log("Session data not found for ID:", sessionID);
            initializeFileData(path);
          }
        }
      }

      // input is mainet:0x113377
      function initializeLoadData(path) {
        const localData = JSON.parse(localStorage.getItem(path));
        if (localData) {
          hljs.highlightAll();
          displayScanResultsSection(localData.scan_results);
          initScanDropdowns();
          document.getElementById("functionDisplay").innerHTML =
            createFunctionDataView(localData.functions_data);
          document.getElementById("contractDisplay").innerHTML =
            createContractDataView(
              localData.network_info,
              localData.contract_data,
              localData.variables_data
            );
          document.getElementById("searchDisplay").style.display = "block";
          document.getElementById("criteriaDisplay").style.display = "block";
          createSourceCodeView(localData.source_code);
          document.getElementById("homepage").style.display = "none";
        } else {
          console.log("Session data not found for ID:", path);
          initializeFileData(path);
        }
      }

      async function initializeFileData(path) {
        const success = await fetchSessionData(path);
        if (success) {
          initializeLoadData(path);
        } else {
          console.log("Local file data not found for ID:", path);
        }
      }

      // ############################### end APP_NAVIGATION

      // ############################### SCAN_RESULTS_DISPLAY

      function filterScanResults() {
        var form = document.getElementById("scanResultFilterForm");
        var formData = new FormData(form);
        var searchCriteria = Object.fromEntries(formData.entries());

        const urlParams = new URLSearchParams(window.location.search);
        let session_path = urlParams.get("session_id");
        var sessionData = getSessionData(session_path);

        fetch("/filter_scan", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ searchCriteria, sessionData }),
        })
          .then((response) => response.json())
          .then((data) => {
            displayScanResultsSection(data);
            document.getElementById("scanResultsContainer").style.display =
              "block";
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function displayScanResultsSection(scanResults) {
        const scanResultsSection =
          document.getElementById("scanResultsSection");
        const scanResultsDisplay =
          document.getElementById("scanResultsDisplay");

        scanResultsSection.style.display = "block";

        if (!scanResults || scanResults.length === 0) {
          scanResultsDisplay.innerHTML =
            "<div>No detector data available</div>";
          return;
        }

        let content = `<div id="scanResultsContainer" style="display: none;">`;

        // Loop through each scan result to create its detailed view
        scanResults.forEach((item) => {
          content += `<div style="margin-bottom: 5px; padding-bottom: 5px;">`;
          Object.keys(item).forEach((propKey) => {
            if (propKey === "path") {
              content += `<div class="path" style="cursor: pointer; color: #0000a2;"><strong>jump-to-line:</strong> ${item[propKey]}</div>`;
            } else if (propKey === "full_name") {
              content += `<div class="function-name" style="cursor: pointer; color: #0000a2;"><strong>jump-to-function:</strong> ${item[propKey]}</div>`;
            } else if (propKey == "expressions") {
              content += `<div class="expressions" style="cursor: pointer; color: #0000a2;"><strong>jump-to-expression:</strong> ${item[propKey]}</div>`;
            } else {
              content += `<div><strong>${propKey}:</strong> ${item[propKey]}</div>`;
            }
          });
          content += `</div>`;
        });

        content += "</div>";
        scanResultsDisplay.innerHTML = content;
        scanResultsSection.style.display = "block";

        // Add click event listener to path elements
        document.querySelectorAll(".path").forEach((pathElement) => {
          pathElement.addEventListener("click", function () {
            const path = this.textContent.split(": ")[1];
            const pathParts = path.split("/");
            const contractName = pathParts[pathParts.length - 1]
              .split("#")[0]
              .split(".")[0];
            const [startLine, endLine] = pathParts[pathParts.length - 1]
              .split("#")[1]
              .split("-");
            gotoLinesInEditor(contractName, startLine, endLine);
          });
        });

        document.querySelectorAll(".expressions").forEach((expressions) => {
          expressions.addEventListener("click", function () {
            const expressions = this.textContent.split(": ")[1].split(",");
            jumpToExpression(expressions);
          });
        });

        document
          .querySelectorAll(".function-name")
          .forEach((functionElement) => {
            functionElement.addEventListener("click", function () {
              const functionName = this.textContent.split(": ")[1];
              jumpToFunctionName(functionName);
            });
          });
      }

      function jumpToFunctionName(functionName) {
        const urlParams = new URLSearchParams(window.location.search);
        let session_path = urlParams.get("session_id");
        var sessionData = getSessionData(session_path);

        const functionData = sessionData.functions_data.find(
          (func) => func.function_full_name === functionName
        );

        if (functionData) {
          start_line = functionData.line_numbers[0];
          end_line = functionData.line_numbers[1];
          gotoLinesInEditor(functionData.contract_name, start_line, end_line);
        }
      }

      function jumpToExpression(expressions) {
        console.log("jumpToExpression -> expressions:", expressions);
        const urlParams = new URLSearchParams(window.location.search);
        let session_path = urlParams.get("session_id");
        var sessionData = getSessionData(session_path);

        const expressionData = sessionData.functions_data.find((func) =>
          expressions.some((expression) =>
            func.expressions.includes(expression)
          )
        );

        if (expressionData) {
          start_line = expressionData.line_numbers[0];
          end_line = expressionData.line_numbers[1];
          gotoLinesInEditor(expressionData.contract_name, start_line, end_line);
        }
      }

      function toggleScanResultsDisplay() {
        const container = document.getElementById("scanResultsContainer");
        container.style.display =
          container.style.display === "none" ? "block" : "none";
      }

      // ############################### end SCAN_RESULTS_DISPLAY

      // ############################### MAIN_FUNCTIONS

      const SUPPORTED_NETWORKS = {
        "mainet:": "etherscan.io",
        "optim:": "optimistic.etherscan.io",
        "goerli:": "goerli.etherscan.io",
        "sepolia:": "sepolia.etherscan.io",
        "tobalaba:": "tobalaba.etherscan.io",
        "bsc:": "bscscan.com",
        "testnet.bsc:": "testnet.bscscan.com",
        "arbi:": "arbiscan.io",
        "testnet.arbi:": "testnet.arbiscan.io",
        "poly:": "polygonscan.com",
        "mumbai:": "testnet.polygonscan.com",
        "avax:": "snowtrace.io",
        "testnet.avax:": "testnet.snowtrace.io",
        "ftm:": "ftmscan.com",
        "goerli.base:": "goerli.basescan.org",
        "base:": "basescan.org",
        "gno:": "gnosisscan.io",
        "polyzk:": "zkevm.polygonscan.com",
      };

      function loadData() {
        // Get the button element
        var button = document.querySelector("#inputGroup button");

        // Change the button text to "Loading..."
        button.textContent = "Loading...";

        var path = document.getElementById("pathInput").value;
        var param = document.getElementById("paramInput").value;

        // Check and transform the path if it's a supported network URL
        var sortedPath = sortPath(path);

        if (sortedPath === "network_url_target") {
          var targetPath = getTargetFromUrl(path);
          if (targetPath) {
            path = targetPath;
          }
        }

        // localStorage is only used for single session storage
        // otherwise send POST to download or retrive from local filesystem
        // NOTE: Clearing localStorage should happen on switch to different session_id url
        if (localStorage.getItem(path)) {
          console.log("session_path", path);
          console.log("localStorage.getItem(path)", storedData);
          window.history.pushState(path, "", `/?session_id=${path}`);
          initializeLoadData(path);
        } else {
          console.log("Rendering new path in loadData()", path);
          fetch("/", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body:
              "path=" +
              encodeURIComponent(path) +
              "&param=" +
              encodeURIComponent(param),
          })
            .then((response) => {
              if (!response.ok) {
                return response.text().then((text) => {
                  throw new Error(text);
                });
              }
              return response.json();
            })
            .then((data) => {
              localStorage.setItem(path, JSON.stringify(data));
              window.history.pushState(path, "", `/?session_id=${path}`);

              displayScanResultsSection(data.scan_results);
              initScanDropdowns();
              document.getElementById("functionDisplay").innerHTML =
                createFunctionDataView(data.functions_data);
              document.getElementById("contractDisplay").innerHTML =
                createContractDataView(
                  data.network_info,
                  data.contract_data,
                  data.variables_data
                );
              document.getElementById("searchDisplay").style.display = "block";
              document.getElementById("criteriaDisplay").style.display =
                "block";
              createSourceCodeView(data.source_code);
              document.getElementById("homepage").style.display = "none";
              button.textContent = "Load";
            })
            .catch((error) => {
              console.error("Error:", error);
              document.getElementById("homepage").style.display = "none";
              document.getElementById("functionDisplay").innerHTML =
                "<strong>Wrong Input:</strong> " + error.message;
            });
        }
      }

      function isValidHttpUrl(string) {
        let url;

        try {
          url = new URL(string);
        } catch (_) {
          return false; // If an error is thrown, it is not a URL
        }

        return url.protocol === "http:" || url.protocol === "https:";
      }

      function sortPath(path) {
        if (isValidHttpUrl(path) && checkIfSupportedNetworkInUrl(path)) {
          return "network_url_target";
        }
        if (path.startsWith("/")) {
          // Assuming directory paths start with '/'
          return "dir_target";
        }
        if (path.includes(":") && !path.includes("/")) {
          return "network_target"; // For <network>:<address> format
        }
        return null; // Default return if none of the above
      }

      function checkIfSupportedNetworkInUrl(path) {
        if (!isValidHttpUrl(path)) {
          return false; // Immediately return false if it's not a valid URL
        }

        const domain = new URL(path).hostname;
        return Object.values(SUPPORTED_NETWORKS).some((networkUrl) =>
          domain.includes(networkUrl)
        );
      }

      function getTargetFromUrl(path) {
        if (!isValidHttpUrl(path)) {
          return null; // Return null if not a valid URL
        }

        const url = new URL(path);
        const domain = url.hostname;
        const pathSegments = url.pathname.split("/");
        const ethAddress = pathSegments.find((segment) =>
          /^0x[a-fA-F0-9]{40}$/.test(segment)
        );

        if (!ethAddress) {
          return null;
        }

        const sortedNetworks = Object.entries(SUPPORTED_NETWORKS).sort(
          (a, b) => b[1].length - a[1].length
        );

        for (const [network, url] of sortedNetworks) {
          if (domain.includes(url)) {
            return `${network}${ethAddress}`; // Correct the network key by removing the colon
          }
        }
        return null;
      }

      function filterData() {
        var form = document.getElementById("searchForm");
        var formData = new FormData(form);
        var searchCriteria = Object.fromEntries(formData.entries());
        const urlParams = new URLSearchParams(window.location.search);
        let session_path = urlParams.get("session_id");
        var sessionData = getSessionData(session_path);
        // Ugly hack because we wrap everything in <form>> in html
        delete searchCriteria["findAction[]"];
        delete searchCriteria["findTarget[]"];

        for (let key in searchCriteria) {
          if (searchCriteria[key] === "") {
            delete searchCriteria[key];
          }
        }

        // Transform selectedActionTargets into the desired flat structure
        selectedActionTargets.forEach((actionObj) => {
          if (searchCriteria[actionObj.action]) {
            // Merge if there's already an entry for this action
            searchCriteria[actionObj.action] = [
              ...new Set([
                ...searchCriteria[actionObj.action],
                ...actionObj.targets,
              ]),
            ];
          } else {
            // Create a new entry if it doesn't exist
            searchCriteria[actionObj.action] = actionObj.targets;
          }
        });
        console.log("filterData() -> searchCriteria:", searchCriteria);
        fetch("/filter", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ searchCriteria, sessionData }),
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("functionDisplay").innerHTML =
              createFunctionDataView(data);
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      // ############################### end MAIN_FUNCTIONS

      // ############################### SOURCE_CODE_VIEW

      function createSourceCodeView(sourceCode) {
        const urlParams = new URLSearchParams(window.location.search);
        let session_path = urlParams.get("session_id");
        var sessionData = getSessionData(session_path);

        var sourceCodeDisplay = document.getElementById("sourceCodeDisplay");
        sourceCodeDisplay.innerHTML = "";

        var select = document.createElement("select");
        select.onchange = function () {
          var contractName = this.value;
          displaySourceCode(contractName, sourceCode[contractName].source_code);
        };
        sourceCodeDisplay.appendChild(select);

        var editorContainer = document.createElement("div");
        editorContainer.id = "editor";
        editorContainer.style.width = "100%";
        sourceCodeDisplay.appendChild(editorContainer);

        editor = ace.edit("editor");
        editor.setReadOnly(true);
        editor.setTheme("ace/theme/chrome");
        editor.session.setMode("ace/mode/solidity");

        editor.setOptions({
          maxLines: 150,
          minLines: 10,
        });

        // Adjust the editor's initial height to be more flexible
        editorContainer.style.minHeight = "100px";

        function displaySourceCode(contractName, source) {
          editor.setValue(source, -1); // -1 moves the cursor to the start
        }

        var orderedContracts = orderSourceCodeFiles(
          sessionData.contract_data.contract_name,
          sessionData.contract_data.immediate_inheritance,
          sourceCode
        );

        // Populate the dropdown with ordered source code files
        orderedContracts.forEach((contractName) => {
          var option = document.createElement("option");
          option.value = contractName;
          option.text = contractName;

          if (contractName === sessionData.contract_data.contract_name) {
            option.style.color = "red";
          } else if (
            sessionData.contract_data.immediate_inheritance &&
            sessionData.contract_data.immediate_inheritance.includes(
              contractName
            )
          ) {
            option.style.color = "orange";
          } else {
            option.style.color = "green";
          }
          select.appendChild(option);
        });

        // Optionally display first source code by default
        if (select.options.length > 0) {
          select.onchange();
        }
      }

      function orderSourceCodeFiles(
        contractName,
        contractsInherited,
        sourceCode
      ) {
        let orderedContracts = [contractName]; // Start with the main contract
        // Add inherited contracts in order
        if (contractsInherited && contractsInherited.length) {
          orderedContracts = orderedContracts.concat(contractsInherited);
        }
        // Add remaining contracts that are not in the inherited list
        Object.keys(sourceCode).forEach((key) => {
          if (!orderedContracts.includes(key)) {
            orderedContracts.push(key);
          }
        });
        return orderedContracts;
      }

      function gotoLinesInEditor(contractName, startLine, endLine) {
        // Check if the desired contract is already selected
        var select = document
          .getElementById("sourceCodeDisplay")
          .querySelector("select");
        if (select.value !== contractName) {
          // Change the dropdown to the correct contract
          select.value = contractName;
          // Manually trigger the onchange event for the select element
          select.onchange();

          // Wait for the editor to load the new contract's source code
          setTimeout(function () {
            scrollToLines(startLine, endLine);
          }, 100); // Adjust delay as necessary to ensure the source code is loaded
        } else {
          // If the correct contract is already displayed, scroll directly
          scrollToLines(startLine, endLine);
        }
      }

      function scrollToLines(startLine, endLine) {
        editor.scrollToLine(startLine, true, true);
        var sourceCodeDisplay = document.getElementById("sourceCodeDisplay");
        var Range = ace.require("ace/range").Range;
        var endColumn = endLine === startLine ? Infinity : 0;
        editor.session.selection.setRange(
          new Range(startLine - 1, 0, endLine - 1, endColumn)
        );
        sourceCodeDisplay.scrollIntoView();
      }

      // ############################### end SOURCE_CODE_VIEW

      // ############################### CONTRACT_DATA_VIEW

      function createContractDataView(
        networkInfo,
        contractData,
        variablesData
      ) {
        let content = "<div class='contract-section'>";
        if (!networkInfo && !contractData) {
          return content + "<div>No contract information available</div></div>";
        }

        content += createContractDetailDataView(
          "Network Information",
          networkInfo
        );
        content += createContractDetailDataView("Contract Data", contractData);

        content += createContractDetailDataView(
          "State Variables",
          variablesData
        );

        document
          .querySelector("body")
          .addEventListener("click", function (event) {
            let element = event.target;
            while (element) {
              if (element.matches(".variable-name")) {
                const contractName = element.dataset.contractName;
                const startLine = element.dataset.startLine;
                const endLine = element.dataset.endLine;
                gotoLinesInEditor(contractName, startLine, endLine);
                break;
              }
              element = element.parentElement;
            }
          });

        return content + "</div>";
      }

      function createContractDetailDataView(title, dataObject) {
        let content = `<h3>${title}</h3><div>`;
        if (!dataObject) {
          return content + "<div>Not available</div></div>";
        }

        let removeKeys = [
          "all_external_calls",
          "all_reachable_from_functions",
          "all_function_names",
          "all_paths_to_functions",
          "structures_elements",
          "structures_types",
          "structures_with_elements",
          "contract_lines",
          "all_variables",
          "",
        ];

        content += '<div style="margin-bottom: 20px;">';
        if (title == "State Variables") {
          return content + createVariableDataView(dataObject) + "</div>";
        }

        for (let key in dataObject) {
          // Skip if the key is in the array of keys to skip
          if (removeKeys.includes(key) || isEmpty(dataObject[key])) {
            continue;
          }

          let value = dataObject[key];
          if (Array.isArray(value)) {
            value = value.join(", ");
            content += `<div><strong>${key}</strong>: ${value}</div>`;
          } else if (typeof value === "object" && value !== null) {
            value = JSON.stringify(value, null, 2)
              .replace(/\n/g, "<br>")
              .replace(/ /g, "&nbsp;");
            content += `<div><strong>${key}</strong>: ${value}</div>`;
          } else {
            // Handle simple values
            content += `<div><strong>${key}</strong>: ${value}</div>`;
          }
        }
        content += "</div>";

        return content + "</div>";
      }

      // ############################### end CONTRACT_DATA_VIEW

      // ############################### VARIABLE_DATA_VIEW

      function createVariableDataView(dataObject) {
        let content = "";

        // Organize state variables by contract name
        let contracts = {};
        dataObject.forEach((variable) => {
          let contractName = variable.contract_name;
          if (!contracts.hasOwnProperty(contractName)) {
            contracts[contractName] = [];
          }
          contracts[contractName].push(variable); // Push the entire variable object
        });

        // Display state variables for each contract
        for (let contractName in contracts) {
          content += `<h4>${contractName}</h4>`;

          contracts[contractName].forEach((variable) => {
            let value = variable.variable_body;
            let variableNameIndex = value.indexOf(variable.variable_name);

            if (variableNameIndex !== -1) {
              let beforeVariableName = value.substring(0, variableNameIndex);
              let afterVariableName = value.substring(
                variableNameIndex + variable.variable_name.length
              );
              value = `<div class="variable-name" data-contract-name="${variable.contract_name}" data-start-line="${variable.line_numbers[0]}" data-end-line="${variable.line_numbers[1]}" style="cursor: pointer; color: #0000a2;">${beforeVariableName}<strong>${variable.variable_name}</strong>${afterVariableName}</div>`;
            }

            content += `<div>${value}</div>`;
          });
        }

        content += "</div>";

        return content;
      }

      // ############################### end VARIABLE_DATA_VIEW

      // ############################### FUNCTION_DATA_VIEW

      function createFunctionDataView(data) {
        if (!data || !data.length) {
          return "<div>No data matching criteria found</div>";
        }

        let priorityGroups = { 1: "", 2: "", 3: "" };
        data.forEach((item) => {
          if (
            item &&
            item.priority &&
            priorityGroups[item.priority] !== undefined
          ) {
            let dataInfoContent = formatFunctionData(item);
            priorityGroups[item.priority] += `
            <div class="data-section">
              <button class="collapsible selectable-text">${item.function_full_name}</button>
                
              <div class="function-content">
                    <div class="data-info">${dataInfoContent}</div>
                    <div class="key-content" style="display: none;"></div> <!-- Single key-content area -->
                </div>
            </div>
        `;
          }
        });

        let content = "";

        // Append the priority groups to the content
        Object.keys(priorityGroups).forEach((priority) => {
          if (priorityGroups[priority]) {
            let priorityLabel =
              priority == 1
                ? "Write (public/external)"
                : priority == 2
                ? "Write (internal/private)"
                : priority == 3
                ? "Read (view/pure)"
                : `Priority ${priority}`;
            content += `
            <div class="priority-group">
                <h2>${priorityLabel}</h2>
                ${priorityGroups[priority]}
            </div>
        `;
          }
        });
        return content;
      }

      function formatFunctionData(item) {
        let formattedData = '<div class="data-info">';
        let keyContents = "";
        let expandableButtons = "";

        // Define which keys to display as list or buttons
        const removeKeys = ["priority"];
        const listKeys = ["description"];
        const buttonKeys = [
          "function_full_name",
          "function_body",
          "function_selector",
          "variable_body",
          "variable_type",
          "signature_str",
          "internal_functions",
          "external_calls",
          "modifiers_body",
          "state_vars_read",
          "state_vars_written",
          "all_reachable_from_functions",
          "variables",
          "expressions",
          "high_level_calls",
          "library_level_calls",
          "all_conditional_state_variables_read",
          "prompts",
        ];

        // Define keys that require syntax highlighting
        const syntaxHighlightKeys = [
          "function_body",
          "internal_functions",
          "modifiers_body",
        ];

        for (let key in item) {
          if (removeKeys.includes(key) || !item[key] || isEmpty(item[key]))
            continue;

          let contentId =
            "content_" + key + "_" + Math.random().toString(36).substr(2, 9);

          if (listKeys.includes(key)) {
            // Add description as listData (server-rendered HTML)
            formattedData += `<div class="list-data">${item[key]}</div>`;
          } else if (buttonKeys.includes(key)) {
            // Prepare expandable buttons HTML
            expandableButtons += `<button class="expandable" data-content-id="${contentId}" onclick="toggleExpandableActive(this)">${key}</button>`;

            if (key === "prompts") {
              let strategiesContent = `<div class="strategy-buttons-container">`;
              Object.keys(item[key]).forEach((strategy) => {
                strategiesContent += `<button class="strategy-button" data-function-sig="${item.function_full_name}" data-strategy="${strategy}" onclick="generatePrompt('${item.function_full_name}', '${strategy}')">${strategy}</button>`;
              });
              strategiesContent += "</div>";
              keyContents += `<div id="${contentId}" class="key-content" style="display: none;">${strategiesContent}<div class="prompt-data-container"></div></div>`;
            } else {
              let content = Array.isArray(item[key])
                ? item[key].join("<br>")
                : item[key];

              // Syntax highlighting for specific keys
              if (syntaxHighlightKeys.includes(key)) {
                content = unescapeHTML(content);
                content = `<pre><code class="language-solidity">${content}</code></pre>`;
              }

              keyContents += `<div id="${contentId}" class="key-content" style="display: none;">${content}</div>`;
            }
          }
        }

        formattedData += expandableButtons;

        // Append the "Go to Lines" button if line_numbers is available
        if (item.line_numbers) {
          formattedData += `<button class="copy-button" onclick="gotoLinesInEditor('${item.contract_name}', ${item.line_numbers[0]}, ${item.line_numbers[1]})">Go to Lines</button>`;
        }

        // Always add the "Copy" button last
        formattedData += `<button class="copy-button" onclick="copyKeyContent()">Copy</button>`;

        formattedData += keyContents;

        formattedData += `</div>`;

        return formattedData;
      }

      function unescapeHTML(str) {
        const temp = document.createElement("div");
        temp.innerHTML = str;
        return temp.textContent || temp.innerText || "";
      }

      function toggleExpandableActive(currentElement) {
        // Allow expandable buttons to toggle without affecting others
        currentElement.classList.toggle("active");
      }

      function generatePrompt(functionSig, strategy) {
        const urlParams = new URLSearchParams(window.location.search);
        let session_path = urlParams.get("session_id");
        var sessionData = getSessionData(session_path);
        const functionData = sessionData.functions_data.find(
          (func) => func.function_full_name === functionSig
        );

        if (!functionData) {
          console.error("Function data not found for signature:", functionSig);
          return;
        }

        fetch("/prompt", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            function_data: functionData,
            strategy_for_function: strategy,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            // Find the parent .data-section of the clicked strategy button
            const parentDataSection = document
              .querySelector(
                `button[data-function-sig="${functionSig}"][data-strategy="${strategy}"]`
              )
              .closest(".data-section");
            if (parentDataSection) {
              // Correctly target the .prompt-data-container within this section to insert the prompt
              const promptDataContainer = parentDataSection.querySelector(
                ".prompt-data-container"
              );
              if (promptDataContainer) {
                promptDataContainer.innerHTML = `<div>${data[strategy]}</div>`;
              }
            }
          })
          .catch((error) => {
            console.error("Error generating prompt:", error);
          });
      }

      // ############################### end FUNCTION_DATA_VIEW

      // ############################### SEARCH_TARGET_TOOL

      function updateCriteriaDisplay() {
        var form = document.getElementById("searchForm");
        var formData = new FormData(form);
        var searchCriteria = Object.fromEntries(formData.entries());

        delete searchCriteria["findAction[]"];
        delete searchCriteria["findTarget[]"];

        for (let key in searchCriteria) {
          if (searchCriteria[key] === "") {
            delete searchCriteria[key];
          }
        }

        var criteriaText = "<strong>Active Filter:</strong><br>";
        for (let key in searchCriteria) {
          criteriaText += `<strong>${key}</strong>: ${searchCriteria[key]}<br>`;
        }

        selectedActionTargets.forEach((actionObj) => {
          criteriaText += `<strong>${
            actionObj.action
          }</strong>: ${actionObj.targets.join(", ")}<br>`;
        });

        document.getElementById("criteriaDisplay").innerHTML = criteriaText;
      }

      function populateTargets(actions) {
        const urlParams = new URLSearchParams(window.location.search);
        let session_path = urlParams.get("session_id");
        var sessionData = getSessionData(session_path);

        var targetDropdown = document.getElementById("findTarget");
        targetDropdown.innerHTML = '<option value="">Select Target</option>'; // Reset dropdown

        var targets = [];

        actions.forEach((action) => {
          switch (action) {
            case "emitting":
              targets = sessionData.contract_data.events.map((event) => ({
                name: event,
                value: event,
              }));
              break;
            case "writing_to":
            case "reading_from":
              targets = sessionData.contract_data.all_variables.map(
                (variable) => ({ name: variable, value: variable })
              );
              break;
            case "calling_external_contract":
              targets = sessionData.contract_data.all_external_calls.map(
                (call) => ({ name: call, value: call })
              );
              break;
            case "find_target_reachable":
            case "all_reachable_from":
              targets = sessionData.contract_data.all_function_names.map(
                (func) => ({ name: func, value: func })
              );
              break;
            case "using_structure":
              targets = sessionData.contract_data.structures.map((struct) => ({
                name: struct,
                value: struct,
              }));
              break;
            case "in_contract":
              targets = [
                sessionData.contract_data.contract_name,
                ...sessionData.contract_data.immediate_inheritance,
              ].map((contract) => ({ name: contract, value: contract }));
              break;
          }
        });

        targets = Array.from(
          new Set(targets.map((target) => JSON.stringify(target)))
        ).map((str) => JSON.parse(str));

        // Populate the target dropdown with options based on the selected action
        targets.forEach(function (target) {
          var option = new Option(target.name, target.value);
          targetDropdown.add(option);
        });
      }

      function handleTargetSelection(action, target) {
        let actionObj = selectedActionTargets.find((a) => a.action === action);
        if (!actionObj) {
          actionObj = { action: action, targets: [] };
          selectedActionTargets.push(actionObj);
        }

        // Check if the target is already included for the action
        const targetIndex = actionObj.targets.indexOf(target);

        // If found, remove the target (deselect it)
        if (targetIndex > -1) {
          actionObj.targets.splice(targetIndex, 1);
        } else {
          // Target not found, so add it (select it)
          actionObj.targets.push(target);
        }

        console.log(selectedActionTargets);
      }

      // ############################### end SEARCH_TARGET_TOOL

      // ############################## UTILS

      function formatKeyData(key, keyData) {
        if (Array.isArray(keyData)) {
          keyData = keyData.join("<br>");
        } else if (typeof keyData !== "string") {
          keyData = JSON.stringify(keyData, null, 2);
        }
        return keyData;
      }

      function escapeHTML(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function isEmpty(value) {
        return (
          value === "" ||
          value === null ||
          (Array.isArray(value) && value.length === 0) ||
          (typeof value === "object" && Object.keys(value).length === 0)
        );
      }

      function copyKeyContent() {
        // Find the last active key-content to copy from
        let keyContents = document.querySelectorAll(".key-content.active");
        if (keyContents.length > 0) {
          let activeKeyContent = keyContents[keyContents.length - 1]; // Get the last one that was activated
          // Create a textarea element to help with copying
          let textarea = document.createElement("textarea");
          textarea.value = activeKeyContent.innerText;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand("copy");
          document.body.removeChild(textarea);
        } else {
          alert("No active key content found.");
        }
      }

      function resetSelections() {
        selectedActionTargets = [];
        document.getElementById("searchForm").reset();
        document.getElementById("criteriaDisplay").innerHTML = "";
        document.getElementById("findTarget").innerHTML =
          '<option value="">Select Target</option>';
      }

      function populateScanDropdown(dropdownId, dataKey) {
        const urlParams = new URLSearchParams(window.location.search);
        let session_path = urlParams.get("session_id");
        /// mainet:0x1337 (no name, no path)
        console.log("populateScanDropdown -> session_path", session_path);
        var sessionData = getSessionData(session_path); /// getSessionData doesn't retrive sessionData.json!!!
        console.log("populateScanDropdown -> sessionData", sessionData);
        var dropdown = document.getElementById(dropdownId);
        dropdown.innerHTML = '<option value="">All</option>';

        const uniqueValues = Array.from(
          new Set(sessionData.scan_results.map((item) => item[dataKey]))
        ).sort(); // Sorting for better usability

        // Populate the dropdown with options
        uniqueValues.forEach((value) => {
          const option = new Option(value, value);
          dropdown.add(option);
        });
      }

      function initScanDropdowns() {
        populateScanDropdown("checkSelect", "check");
        populateScanDropdown("functionSelect", "full_name");
        populateScanDropdown("contractSelect", "contract");
      }

      // ############################## end UTILS

      // ############################### EVENTS

      // Localstorage session tracking through refreshes
      document.addEventListener("DOMContentLoaded", function () {
        hljs.highlightAll();
        initializePageWithData();
        poupulateSessionStorageDropdown();
      });

      document
        .getElementById("searchForm")
        .addEventListener("change", updateCriteriaDisplay);

      // Add event listener to the filter input for dynamic filtering
      document
        .getElementById("findTargetFilter")
        .addEventListener("input", function () {
          const filterText = this.value.toLowerCase();
          const findTargetDropdown = document.getElementById("findTarget");
          const options = findTargetDropdown.options;

          // Temporarily store options in an array to filter in JavaScript instead of live HTMLCollection
          const optionsArray = Array.from(options);

          // Hide all options initially
          optionsArray.forEach((option) => {
            option.style.display = "none";
          });

          // Filter and display matching options
          const filteredOptions = optionsArray.filter((option) =>
            option.text.toLowerCase().includes(filterText)
          );
          filteredOptions.forEach((option) => {
            option.style.display = "block";
          });

          // If filter is empty, reset to show all options
          if (!filterText) {
            optionsArray.forEach((option) => {
              option.style.display = "block";
            });
          }
        });

      document
        .getElementById("findAction")
        .addEventListener("change", function () {
          // Updated to handle multiple selected actions

          var actions = Array.from(this.selectedOptions).map(
            (option) => option.value
          );
          populateTargets(actions);
        });

      document
        .getElementById("findTarget")
        .addEventListener("change", function () {
          // Retrieve the selected action(s) as this will apply to all selected targets
          var selectedActions = Array.from(
            document.getElementById("findAction").selectedOptions
          ).map((option) => option.value);
          // Retrieve the selected target(s)
          var selectedTargets = Array.from(this.selectedOptions).map(
            (option) => option.value
          );

          // For each action, update the global variable with the selected targets
          selectedActions.forEach((action) => {
            selectedTargets.forEach((target) => {
              handleTargetSelection(action, target);
            });
          });
        });

      document.addEventListener(
        "click",
        function (event) {
          if (event.target.matches(".collapsible")) {
            // Toggle collapsible sections
            hljs.highlightAll();
            var functionContent = event.target.nextElementSibling;
            functionContent.style.display =
              functionContent.style.display === "block" ? "none" : "block";
            event.target.classList.toggle("active");
          } else if (event.target.matches(".expandable")) {
            // Handle clicking on expandable buttons
            var contentId = event.target.getAttribute("data-content-id");
            var keyContentDiv = document.getElementById(contentId);

            // Toggle visibility and active state for key-content sections
            if (keyContentDiv.style.display !== "block") {
              keyContentDiv.style.display = "block";
              event.target.classList.add("active");
              keyContentDiv.classList.add("active");
            } else {
              keyContentDiv.style.display = "none";
              event.target.classList.remove("active");
              keyContentDiv.classList.remove("active");
            }

            // Update all other buttons' active state
            document.querySelectorAll(".expandable").forEach((btn) => {
              if (btn !== event.target && btn.classList.contains("active")) {
                let relatedContent = document.getElementById(
                  btn.getAttribute("data-content-id")
                );
                if (!relatedContent.classList.contains("active")) {
                  btn.classList.remove("active");
                }
              }
            });
          }
        },
        false
      );
    </script>
  </body>
</html>
